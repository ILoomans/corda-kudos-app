import static org.gradle.api.JavaVersion.VERSION_11

plugins {
    id 'org.jetbrains.kotlin.jvm'

    // (1)
    id 'net.corda.plugins.cordapp-cpb'
}

configurations {
    combinedWorker{
        canBeConsumed = false
        canBeResolved= true
    }
}

dependencies {
    combinedWorker "net.corda:corda-combined-worker:5.0.0.0-beta+"
}

group 'org.example'
version '1.0-SNAPSHOT'

def javaVersion = VERSION_11

// (2)
cordapp {
    targetPlatformVersion platformVersion as Integer
    minimumPlatformVersion platformVersion as Integer
    workflow {
        name "ModuleNameHere"
        versionId 1
        vendor "VendorNameHere"
    }
}


// (3)
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
    kotlinOptions {
        allWarningsAsErrors = true
        languageVersion = '1.6'
        apiVersion = '1.6'
        jvmTarget = javaVersion
        freeCompilerArgs += [
                "-java-parameters",
                "-Xjvm-default=all"
        ]
    }
}

// (4)
repositories {

    // Needed for kotlin osgi bundles generated by us.
    // Will be published to MavenCentral for when we do the GA release
    maven {
        url = "$artifactoryContextUrl/corda-dependencies"
    }

    // Needed for current C5 binaries.
    // These will be published to MavenCentral when we do the GA release
    maven {
        url = "$artifactoryContextUrl/corda-os-maven"
        credentials {
            username = findProperty('cordaArtifactoryUsername') ?: System.getenv('CORDA_ARTIFACTORY_USERNAME')
            password = findProperty('cordaArtifactoryPassword') ?: System.getenv('CORDA_ARTIFACTORY_PASSWORD')
        }
    }
    
    maven {
        url = "$artifactoryContextUrl/corda-ent-maven-unstable-local"
        credentials {
            username = findProperty('cordaArtifactoryUsername') ?: System.getenv('CORDA_ARTIFACTORY_USERNAME')
            password = findProperty('cordaArtifactoryPassword') ?: System.getenv('CORDA_ARTIFACTORY_PASSWORD')
        }
    }

    // C5 Binaries should go here.
    mavenCentral()
}

// (5)
dependencies {
    // We need to use kotlin stdlib built as an OSGi Bundle
    cordaProvided 'net.corda.kotlin:kotlin-stdlib-jdk8-osgi'
    cordaProvided platform("net.corda:corda-api:$cordaApiVersion")
    cordaProvided 'net.corda:corda-application'
    cordaProvided 'org.slf4j:slf4j-api'
}

test {
    useJUnitPlatform()
}

tasks.register("downloadCombinedWorkerLatest", Copy) {
    from configurations.combinedWorker
    into "$buildDir/downloadedDependencies"
}
